<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <title>Quick Poll</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="/css/style.css">
</head>
<body class="container mt-5">
  <h1 class="text-center mb-4">Vilas's Quick Poll</h1>

  <div th:if="${poll == null}" class="alert alert-warning text-center">
    No poll available. <a href="/create">Create one</a>
  </div>

  <div th:if="${poll != null}" class="card animated fadeIn mb-4">
    <div class="card-body">
      <h3 class="card-title" th:text="${poll.question}"></h3>
      <form method="post" action="/vote" class="mt-3">
        <div th:each="option, stat : ${poll.options}" class="form-check mb-2">
          <input class="form-check-input" type="radio" name="optionIndex" th:id="${'option' + stat.index}" th:value="${stat.index}" required>
          <label class="form-check-label" th:for="${'option' + stat.index}" th:text="${option.name}"></label>
        </div>
        <button type="submit" class="btn btn-primary w-100 mt-3">Vote</button>
      </form>
      <hr class="my-4">
      <div class="mt-4">
        <h4 class="mb-3">Current Poll Results:</h4>
        <div th:with="totalVotes=${#aggregates.sum(poll.options.![votes])}">
          <div th:if="${totalVotes > 0}">
            <div th:each="option, stat : ${poll.options}" class="d-flex justify-content-between align-items-center mb-2">
              <div>
                <span th:if="${stat.index % 4 == 0}" class="text-primary">ðŸ”µ</span>
                <span th:if="${stat.index % 4 == 1}" class="text-success">ðŸŸ¢</span>
                <span th:if="${stat.index % 4 == 2}" class="text-warning">ðŸŸ </span>
                <span th:if="${stat.index % 4 == 3}" class="text-danger">ðŸ”´</span>
                <span th:text="${option.name}"></span>:
              </div>
              <span class="badge bg-secondary rounded-pill" th:text="${option.votes}"></span> votes
            </div>

            <div class="progress mt-3" style="height: 20px;">
              <div th:each="option, stat : ${poll.options}"
                   th:with="percentage=(${option.votes} * 100.0 / ${totalVotes})"
                   class="progress-bar"
                   th:classappend="${stat.index % 4 == 0 ? 'bg-primary' : (stat.index % 4 == 1 ? 'bg-success' : (stat.index % 4 == 2 ? 'bg-warning' : 'bg-danger'))}"
                   role="progressbar"
                   th:style="'width: ' + ${percentage} + '%'"
                   th:aria-valuenow="${option.votes}"
                   aria-valuemin="0"
                   th:aria-valuemax="${totalVotes}">
                <span th:if="${percentage > 5}" th:text="${#numbers.formatDecimal(percentage, 0, 0)} + '%'"></span>
              </div>
            </div>
          </div>
          <div th:unless="${totalVotes > 0}" class="alert alert-info mt-3 text-center">
            No votes yet for this poll. Be the first to vote!
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="text-center mb-5">
    <a href="/create" class="btn btn-lg btn-success">Create Another Poll</a>
  </div>

  <h2 class="mt-5 mb-3">Poll History</h2>
  <div th:if="${pollHistory.isEmpty()}" class="alert alert-info text-center">
    No past polls to display.
  </div>

  <div th:unless="${pollHistory.isEmpty()}">
    <div th:each="historicalPoll, stat : ${pollHistory}" class="card mb-3">
      <div class="card-header bg-light">
        <h5 class="mb-0" th:text="${historicalPoll.question}"></h5>
      </div>
      <div class="card-body">
        <div th:with="totalHistoricalVotes=${#aggregates.sum(historicalPoll.options.![votes])}">
          <div th:if="${totalHistoricalVotes > 0}">
            <p class="card-text">Results:</p>
            <ul class="list-group list-group-flush mb-3">
              <li th:each="option : ${historicalPoll.options}" class="list-group-item d-flex justify-content-between align-items-center">
                <span th:text="${option.name}"></span>
                <span class="badge bg-secondary rounded-pill" th:text="${option.votes}"></span>
              </li>
            </ul>
            <div class="progress" style="height: 20px;">
              <div th:each="option, optionStat : ${historicalPoll.options}"
                   th:with="percentage=(${option.votes} * 100.0 / ${totalHistoricalVotes})"
                   class="progress-bar"
                   th:classappend="${optionStat.index % 4 == 0 ? 'bg-primary' : (optionStat.index % 4 == 1 ? 'bg-success' : (optionStat.index % 4 == 2 ? 'bg-warning' : 'bg-danger'))}"
                   role="progressbar"
                   th:style="'width: ' + ${percentage} + '%'"
                   th:aria-valuenow="${option.votes}"
                   aria-valuemin="0"
                   th:aria-valuemax="${totalHistoricalVotes}">
                <span th:if="${percentage > 5}" th:text="${#numbers.formatDecimal(percentage, 0, 0)} + '%'"></span>
              </div>
            </div>
          </div>
          <div th:unless="${totalHistoricalVotes > 0}" class="alert alert-info mt-3 text-center">
            No votes for this poll yet.
          </div>
        </div>
        <form th:if="${historicalPoll != poll}" method="post" th:action="@{/selectPoll/{index}(index=${stat.index})}" class="mt-3">
            <button type="submit" class="btn btn-sm btn-outline-info">Make Current Poll</button>
        </form>
      </div>
    </div>
  </div>
</body>
</html>